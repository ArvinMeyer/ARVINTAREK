{% extends "base.html" %}

{% block title %}Create New Campaign - Email Extraction System{% endblock %}

{% block content %}
<div class="px-4 py-6 sm:px-0 max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center mb-4">
            <a href="/campaigns" class="text-gray-500 hover:text-gray-700 mr-4">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </a>
            <h1 class="text-3xl font-bold text-gray-900">Create New Campaign</h1>
        </div>
        <p class="text-sm text-gray-500 ml-10">Design and launch your email marketing campaign</p>
    </div>

    <!-- Warning Banner -->
    <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-400 rounded-lg">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm text-red-700">
                    <strong>IMPORTANT:</strong> Only send emails to recipients who have explicitly opted in. 
                    Ensure compliance with CAN-SPAM, GDPR, and all applicable anti-spam regulations.
                </p>
            </div>
        </div>
    </div>

    <form id="campaign-form" class="space-y-6">
        <!-- Step 1: Campaign Details -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold">1</div>
                <h2 class="ml-3 text-xl font-semibold text-gray-900">Campaign Details</h2>
            </div>
            
            <div class="mt-6 space-y-4">
                <div>
                    <label for="campaign-name" class="block text-sm font-medium text-gray-700 mb-2">
                        Campaign Name <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="campaign-name" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., Summer Sale 2024">
                    <p class="mt-1 text-xs text-gray-500">A descriptive name to identify this campaign</p>
                </div>
                
                <div>
                    <label for="campaign-subject" class="block text-sm font-medium text-gray-700 mb-2">
                        Email Subject <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="campaign-subject" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., Special Offer: 50% Off This Week!">
                    <p class="mt-1 text-xs text-gray-500">The subject line recipients will see in their inbox</p>
                </div>
            </div>
        </div>

        <!-- Step 2: Sender Configuration -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white font-bold">2</div>
                <h2 class="ml-3 text-xl font-semibold text-gray-900">Sender Configuration</h2>
            </div>
            
            <div class="mt-6 space-y-4">
                <div>
                    <label for="smtp-config-id" class="block text-sm font-medium text-gray-700 mb-2">
                        SMTP Server <span class="text-red-500">*</span>
                    </label>
                    <select id="smtp-config-id" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">-- Select SMTP Configuration --</option>
                        {% for smtp_config in smtp_configs %}
                        <option value="{{ smtp_config.id }}">
                            {{ smtp_config.name }} ({{ smtp_config.host }}:{{ smtp_config.port }})
                        </option>
                        {% endfor %}
                    </select>
                    {% if smtp_configs|length == 0 %}
                    <p class="mt-1 text-xs text-red-500">No SMTP configurations found. <a href="/smtp-configs" class="underline">Add one first</a></p>
                    {% else %}
                    <p class="mt-1 text-xs text-gray-500">Choose the SMTP server to send emails through</p>
                    {% endif %}
                </div>
                
                <div>
                    <label for="email-account-id" class="block text-sm font-medium text-gray-700 mb-2">
                        From Email Account <span class="text-red-500">*</span>
                    </label>
                    <select id="email-account-id" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">-- Select Email Account --</option>
                        {% for email_account in email_accounts %}
                        <option value="{{ email_account.id }}" data-smtp="{{ email_account.smtp_config_id }}">
                            {{ email_account.name }} ({{ email_account.from_email }})
                        </option>
                        {% endfor %}
                    </select>
                    {% if email_accounts|length == 0 %}
                    <p class="mt-1 text-xs text-red-500">No email accounts found. <a href="/email-accounts" class="underline">Add one first</a></p>
                    {% else %}
                    <p class="mt-1 text-xs text-gray-500">The email address and name recipients will see</p>
                    {% endif %}
                </div>
                
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <div class="flex">
                        <svg class="w-5 h-5 text-blue-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div class="text-sm text-blue-700">
                            <strong>Tip:</strong> Make sure the selected email account uses the same SMTP configuration. 
                            <a href="/smtp-configs" class="underline">Manage SMTP configurations</a> or 
                            <a href="/email-accounts" class="underline">manage email accounts</a>.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Email Content -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white font-bold">3</div>
                <h2 class="ml-3 text-xl font-semibold text-gray-900">Email Content</h2>
            </div>
            
            <div class="mt-6 space-y-4">
                <div>
                    <label for="campaign-subject-content" class="block text-sm font-medium text-gray-700 mb-2">
                        Email Subject <span class="text-red-500">*</span>
                    </label>
                    <input type="text" id="campaign-subject-content" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., Special Offer: 50% Off This Week!">
                    <p class="mt-1 text-xs text-gray-500">The subject line recipients will see in their inbox</p>
                </div>
                
                <div>
                    <label for="campaign-body" class="block text-sm font-medium text-gray-700 mb-2">
                        Email Body (HTML) <span class="text-red-500">*</span>
                    </label>
                    <textarea id="campaign-body" rows="15" required
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm"
                              placeholder="<h1>Hello!</h1>&#10;<p>This is your email content. Use HTML to format your message.</p>&#10;<p>You can include links, images, and styled content.</p>"></textarea>
                    <p class="mt-1 text-xs text-gray-500">HTML format supported. An unsubscribe link will be automatically added at the bottom.</p>
                </div>
                
                <div>
                    <label for="campaign-body-text" class="block text-sm font-medium text-gray-700 mb-2">
                        Plain Text Version (Optional)
                    </label>
                    <textarea id="campaign-body-text" rows="8"
                              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Optional plain text version for email clients that don't support HTML"></textarea>
                    <p class="mt-1 text-xs text-gray-500">Some email clients prefer plain text. If left empty, HTML will be converted automatically.</p>
                </div>
            </div>
        </div>

        <!-- Step 4: Recipients -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-orange-600 rounded-full flex items-center justify-center text-white font-bold">4</div>
                <h2 class="ml-3 text-xl font-semibold text-gray-900">Recipients</h2>
            </div>
            
            <div class="mt-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="text-2xl font-bold text-blue-600">{{ valid_count }}</div>
                        <div class="text-sm text-gray-600 mt-1">Subscribed Recipients</div>
                        <div class="text-xs text-gray-500 mt-1">Ready to receive emails</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="text-2xl font-bold text-gray-600">{{ total_count }}</div>
                        <div class="text-sm text-gray-600 mt-1">Total Valid Emails</div>
                        <div class="text-xs text-gray-500 mt-1">Including unsubscribed</div>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <label class="flex items-start">
                        <input type="radio" name="recipient-type" value="all" checked
                               class="mt-1 mr-3 text-blue-600 focus:ring-blue-500">
                        <div>
                            <div class="text-sm font-medium text-gray-700">Send to All Subscribed Recipients</div>
                            <div class="text-xs text-gray-500 mt-1">Will send to {{ valid_count }} subscribed email addresses</div>
                        </div>
                    </label>
                    <label class="flex items-start">
                        <input type="radio" name="recipient-type" value="selected"
                               class="mt-1 mr-3 text-blue-600 focus:ring-blue-500">
                        <div>
                            <div class="text-sm font-medium text-gray-700">Select Specific Recipients</div>
                            <div class="text-xs text-gray-500 mt-1">
                                <button type="button" id="select-recipients-btn" 
                                        class="text-blue-600 hover:underline">
                                    Go to Valid Emails page
                                </button> to select specific recipients
                            </div>
                        </div>
                    </label>
                </div>
            </div>
        </div>

        <!-- Step 5: Options -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="flex items-center mb-4">
                <div class="flex-shrink-0 w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold">5</div>
                <h2 class="ml-3 text-xl font-semibold text-gray-900">Campaign Options</h2>
            </div>
            
            <div class="mt-6 space-y-4">
                <div>
                    <label for="campaign-delay" class="block text-sm font-medium text-gray-700 mb-2">
                        Delay Between Emails (seconds) <span class="text-red-500">*</span>
                    </label>
                    <input type="number" id="campaign-delay" min="0" step="0.1" value="20.0" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="e.g., 20.0">
                    <p class="mt-1 text-xs text-gray-500">Time to wait between sending each email (in seconds). Recommended: 20-30 seconds to avoid being flagged as spam.</p>
                </div>
                
                <div class="p-4 bg-green-50 rounded-lg border border-green-200">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-green-600 mr-2 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <div class="text-sm font-medium text-green-800">Unsubscribe Link Enabled</div>
                            <div class="text-xs text-green-700 mt-1">An unsubscribe link will be automatically added to the email footer for compliance with CAN-SPAM, GDPR, and other regulations.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
            <a href="/campaigns" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 font-medium transition-colors">
                Cancel
            </a>
            <button type="button" id="preview-btn" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 font-medium transition-colors">
                Preview
            </button>
            <button type="submit" id="create-btn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md hover:shadow-lg transition-all duration-200 font-medium">
                <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                </svg>
                Create & Send Campaign
            </button>
        </div>
    </form>
</div>

<!-- Preview Modal -->
<div id="preview-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">Email Preview</h3>
            <button id="close-preview" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="border border-gray-300 rounded-lg p-4 bg-white">
            <div class="mb-2 text-sm text-gray-600">
                <strong>From:</strong> <span id="preview-from">-</span><br>
                <strong>Subject:</strong> <span id="preview-subject">-</span>
            </div>
            <div class="border-t border-gray-200 pt-4" id="preview-body">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('campaign-form');
    const previewBtn = document.getElementById('preview-btn');
    const previewModal = document.getElementById('preview-modal');
    const closePreview = document.getElementById('close-preview');
    const createBtn = document.getElementById('create-btn');
    
    // Validate SMTP and Email account match
    const smtpSelect = document.getElementById('smtp-config-id');
    const emailSelect = document.getElementById('email-account-id');
    const selectRecipientsBtn = document.getElementById('select-recipients-btn');
    
    emailSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const emailSmtpId = selectedOption.getAttribute('data-smtp');
        const selectedSmtpId = smtpSelect.value;
        
        if (emailSmtpId && selectedSmtpId && emailSmtpId !== selectedSmtpId) {
            alert('Warning: The selected email account uses a different SMTP configuration. Please ensure they match.');
        }
    });
    
    // Sync subject fields (from Step 1 and Step 3)
    const subjectField1 = document.getElementById('campaign-subject');
    const subjectField3 = document.getElementById('campaign-subject-content');
    
    // Sync Step 1 subject to Step 3 subject
    if (subjectField1 && subjectField3) {
        subjectField1.addEventListener('input', function() {
            subjectField3.value = this.value;
        });
        
        // Sync Step 3 subject to Step 1 subject
        subjectField3.addEventListener('input', function() {
            subjectField1.value = this.value;
        });
    }
    
    // Handle "Select Specific Recipients" button
    if (selectRecipientsBtn) {
        selectRecipientsBtn.addEventListener('click', function() {
            // Save campaign data to sessionStorage
            const campaignData = {
                name: document.getElementById('campaign-name').value,
                subject: (subjectField3 && subjectField3.value) || (subjectField1 && subjectField1.value) || '',
                body_html: document.getElementById('campaign-body').value,
                body_text: document.getElementById('campaign-body-text').value,
                smtp_config_id: smtpSelect.value,
                email_account_id: emailSelect.value,
                delay_seconds: parseFloat(document.getElementById('campaign-delay').value) || 20.0,
                return_to: '/campaigns/new'
            };
            
            // Validate required fields
            if (!campaignData.name || !campaignData.subject || !campaignData.body_html) {
                alert('Please fill in Campaign Name, Subject, and Email Body before selecting recipients');
                return;
            }
            
            if (!campaignData.smtp_config_id || !campaignData.email_account_id) {
                alert('Please select both SMTP Configuration and Email Account before selecting recipients');
                return;
            }
            
            // Store campaign data
            sessionStorage.setItem('campaign_draft', JSON.stringify(campaignData));
            
            // Redirect to emails/valid with return parameter
            window.location.href = '/emails/valid?return_to=campaign&select_mode=true';
        });
    }
    
    // Preview functionality
    previewBtn.addEventListener('click', function() {
        const subject = (subjectField3 && subjectField3.value) || (subjectField1 && subjectField1.value) || '';
        const body = document.getElementById('campaign-body').value;
        const emailAccountId = emailSelect.value;
        
        // Get email account details
        let fromEmail = '-';
        if (emailAccountId) {
            const selectedOption = emailSelect.options[emailSelect.selectedIndex];
            fromEmail = selectedOption.text.split('(')[1]?.replace(')', '') || '-';
        }
        
        document.getElementById('preview-subject').textContent = subject || '-';
        document.getElementById('preview-from').textContent = fromEmail;
        document.getElementById('preview-body').innerHTML = body || '<p class="text-gray-500 italic">No content yet</p>';
        previewModal.classList.remove('hidden');
    });
    
    closePreview.addEventListener('click', function() {
        previewModal.classList.add('hidden');
    });
    
    previewModal.addEventListener('click', function(e) {
        if (e.target === previewModal) {
            previewModal.classList.add('hidden');
        }
    });
    
    // Form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
            const campaignName = document.getElementById('campaign-name').value;
            const subject = document.getElementById('campaign-subject-content').value || document.getElementById('campaign-subject').value;
            const bodyHtml = document.getElementById('campaign-body').value;
            const bodyText = document.getElementById('campaign-body-text').value;
            const smtpConfigId = smtpSelect.value;
            const emailAccountId = emailSelect.value;
            const recipientType = document.querySelector('input[name="recipient-type"]:checked').value;
            const delaySeconds = parseFloat(document.getElementById('campaign-delay').value) || 20.0;
            const includeUnsubscribe = true; // Always enabled by default (required for compliance)
        
        if (!smtpConfigId || !emailAccountId) {
            alert('Please select both SMTP Configuration and Email Account');
            return;
        }
        
        createBtn.disabled = true;
        createBtn.textContent = 'Creating Campaign...';
        
        // Get recipients based on selection
        let recipientsPromise;
        if (recipientType === 'all') {
            recipientsPromise = fetch('/sender/get-subscribed')
                .then(response => response.json())
                .then(data => data.emails || []);
        } else {
            alert('Please go to Valid Emails page to select specific recipients');
            createBtn.disabled = false;
            createBtn.textContent = 'Create & Send Campaign';
            return;
        }
        
        recipientsPromise.then(emails => {
            if (emails.length === 0) {
                alert('No recipients found. Please ensure you have subscribed email addresses.');
                createBtn.disabled = false;
                createBtn.textContent = 'Create & Send Campaign';
                return;
            }
            
            fetch('/sender/batch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    emails: emails,
                    subject: subject,
                    body_html: bodyHtml,
                    body_text: bodyText,
                    include_unsubscribe: includeUnsubscribe,
                    smtp_config_id: parseInt(smtpConfigId),
                    email_account_id: parseInt(emailAccountId),
                    campaign_name: campaignName,
                    delay_seconds: delaySeconds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`Campaign created successfully! ${data.count || emails.length} emails queued for sending.`);
                    window.location.href = '/campaigns';
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                    createBtn.disabled = false;
                    createBtn.textContent = 'Create & Send Campaign';
                }
            })
            .catch(error => {
                alert('Error: ' + error);
                createBtn.disabled = false;
                createBtn.textContent = 'Create & Send Campaign';
            });
        });
    });
});
</script>
{% endblock %}

